<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balloon Task</title>
    <link rel="stylesheet" href="bartStyles.css">
    <script src="jatos.js"></script> 
</head>
<body>
    <div id="instructions">
        <h2>Instructions</h2>
        <p>Press <strong>'F'</strong> or <strong>Left Arrow</strong> to inflate the balloon.</p>
        <p>Press <strong>'J'</strong> or <strong>Right Arrow</strong> to cash in your points.</p>
    </div>
    <img id="balloonImage" src="" alt="Resizable Image">
    <audio id="inflateAudio" src="inflate.mp3"></audio>
    <audio id="bankAudio" src="bankAudio.mp3"></audio>
    <audio id="popAudio" src="popAudio.mp3"></audio>
    <div id="message"></div>
    <div id="balloon"></div>
    <div id="piggyContainer">
            <img id="piggyBank" src="piggyBank.png">
            <div id="totalPoints"><span id="totalPoints">0</span></div>  
    </div>
    <div id="lastBalloon"></div>
    <div id="balloonInflations"></div>
    <div id="messageContainer"></div>
    <button id="abortButton" onclick="abortStudy()" aria-label="Abort Study">Abort Study</button>
    <script src="bartLoop.js"></script>
    <script>
    // Balloon Analogue Risk Task
    // Zach Tefertiller - zachary.tefertiller@tum.de
    // Date: October 2024
    // Knolle Lab -- TUM 

    /* For parameters of the task itself you can:
    1) Read in your own arrays via JSON (balloons.json) for balloon order or breakpoints ie arraygenerator.py on the github
    2) Edit experiment parameters in experimentFunctions.js
    */
    
    let studyInProgress = true

    // You need to link in your balloon images
    let blueImage = "barbieBalloon.png";
    let orangeImage = "jungleBalloon.png";
    let yellowImage = "lilacBalloon.png";


    let participantID = null;
    jatos.onLoad(() => {
        participantID = jatos.studySessionData?.participantID || 'test';
        if (participantID !== 'test') {
            console.log("Participant ID from session data:", participantID);
        } else {
            console.warn("Using fallback participant ID:", participantID);
        }
    });



    const startTime = performance.now();
    document.addEventListener("DOMContentLoaded", function() {
        fetch('reversal180.json')
            .then(response => response.json())
            .then(data => initializeWithData(data))
            .catch(error => console.error('Error loading JSON data:', error));
    });


    jatos.onLoad(function () {
    });
    

    function endTask() {
        studyInProgress = false
        const endTime = performance.now();
        const elapsedTime = endTime - startTime;
        
        document.getElementById('piggyBank').style.display = 'none';
        document.getElementById('totalPoints').style.display = 'none';
        message.style.display = 'block';
        message.textContent = `Your total score was ${totalPoints} points. Well done!`;
        
        let finalSummaryData = {
            participant_id: participantID,
            total_score: totalPoints,
            total_pops: calculateTotalPops(), 
            bart_time: Math.round(elapsedTime)
        };
    
        jatos.appendResultData(JSON.stringify(finalSummaryData))
        .then(() => {
            return jatos.studySessionData.bart_total = totalPoints
        })
        .then(() => {
            setTimeout(() => {
                jatos.startNextComponent();
            }, 5000);
        })
        .catch((error) => {
            console.error("Error in final data submission:", error);
            jatos.startNextComponent();
        });
    }


    // prolific stuff
    window.onbeforeunload = function(event) {
        if (studyInProgress) {
            event.preventDefault();
            event.returnValue = 'Are you sure you want to abort the study? Your progress will be lost and the study will be marked as incomplete.';
        }
    };

    function abortStudy() {
        if (confirm("Are you sure you want to abort the study? You will be redirected to Prolific and marked as incomplete.")) {
            window.location.href = 'https://app.prolific.com/submissions/complete?cc=CDIAK6SI';
        }
    }

    </script>
</body>
</html>
